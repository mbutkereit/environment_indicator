<?php
// $Id$

/**
 * @file
 * Adds a coloured strip to the side of the site informing the user which
 * environment they are in (Development, Staging Production etc).
 *
 */

/**
 * Implementation of hook_help().
 */
function environment_indicator_help($path, $arg) {
  switch ($path) {
    case 'admin/settings/environment_indicator':
      return t('The Environment Indicator adds a coloured strip to the side of the site informing you which environment you\'re currently in (Development, Staging Production etc). Use the settings below to customize the appearance of the indicator. You may override these settings in your settings.php file in each of your environments.');

    case 'admin/help#environment_indicator':
      $output = '<p>' .t('The Environment Indicator adds a coloured strip to the side of the site informing you which environment you\'re currently in (Development, Staging Production etc') .'</p>';
      
      $output .= '<p>'. t('The Environment Indicator <a href="@settings">settings page</a> allows you to modify some elements of the indicator\'s behavior and appearance. Since the appearance of the indicator is dependent on your site theme, substantial customisations require modifications to your site\'s theme and CSS files.', array('@settings' => url('admin/settings/environment_indicator'))) . '</p>';
      
      $output .= '<p>'. t('The Environment Indicator\'s visibility depends upon the permissions of the viewer. The <a href="@permissions">access environment indicator</a> permission must be enabled for a user role in order for users of that role to see the indicator.', array('@permissions' => url('admin/user/permissions', array('fragment' => 'module-environment_indicator')))) .'</p>';
      
      $output .= '<p>'. t('The settings for the Environment Indicator, such as the text to display and the color can be overridden for each of your specific environments in the site\'s settings.php file. This allows you to customise the indicator for each environment without needing to make any changes in the database. This means that the Environment Indicator will always display correctly when moving your site from development to staging to production. For example:') .'</p>';
      $output .= '<dl>';
      $output .= '<dt><em>environment_indicator_text</em></dt><dd>'. t('The text that will be displayed vertically down the indicator. e.g:<br/>$conf[\'environment_indicator_text\'] = \'STAGING SERVER\';') .'</dd></dt>';
      $output .= '<dt><em>environment_indicator_color</em></dt><dd>'. t('A valid css color. e.g:<br/>$conf[\'environment_indicator_color\'] = \'red\';') .'</dd></dt>';
      $output .= '<dt><em>environment_indicator_enabled</em></dt><dd>'. t('A boolean value indicating whether the Environment Indicator should be enabled or not. On your production environment, you should probably set this to FALSE. e.g:<br/>$conf[\'environment_indicator_enabled\'] = FALSE;') .'</dd></dt>';
      $output .= '</dl>';
      return $output;
  }
}

/**
 * Implementation of hook_perm().
 */
function environment_indicator_perm() {
  return array('access environment indicator');
}

/**
 * Implementation of hook_menu().
 */
function environment_indicator_menu() {
  $items['admin/settings/environment_indicator'] = array(
    'title' => 'Environment indicator',
    'description' => 'Adjust environment indicator menu settings.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('environment_indicator_settings'),
    'access arguments' => array('administer site configuration'),
  );
  return $items;
}

/**
 * Module settings form.
 */
function environment_indicator_settings() {
  $form['environment_indicator_enabled'] = array(
    '#type' => 'radios',
    '#title' => t('Status'),
    '#default_value' => variable_get('environment_indicator_enabled', 1),
    '#options' => array(t('Disabled'), t('Enabled')),
    '#description' => t('Should the Environment Indicator display?'),
  );
  $form['environment_indicator_position'] = array(
    '#type' => 'select',
    '#title' => t('Position'),
    '#description' => t('Choose a position for the environment indicator.'),
    '#options' => array(
      'left' => t('Left'),
      'right' => t('Right'),
    ),
    '#default_value' => variable_get('environment_indicator_position', 'left'),
  );
  $form['environment_indicator_margin'] = array(
    '#type' => 'checkbox',
    '#title' => t('Adjust margin'),
    '#default_value' => variable_get('environment_indicator_margin', 1),
    '#description' => t('If enabled, the site output is shifted to the left or right approximately 30 pixels to display the environment indicator. If disabled, some absolute- or fixed-positioned page elements may be covered by the environment indicator strip.'),
  );
  $form['environment_indicator_text'] = array(
    '#type' => 'textfield',
    '#title' => t('Text to display'),
    '#default_value' => variable_get('environment_indicator_text', ''),
    '#description' => t('Text to display in the environment indicator. Override this for each environment in settings.php.'),
  );
  $form['environment_indicator_color'] = array(
    '#type' => 'textfield',
    '#title' => t('Colour'),
    '#default_value' => variable_get('environment_indicator_color', '#d00c0c'),
    '#description' => t('The colour of the environment indicator. Override this for each environment in settings.php.'),
    '#size' => 7,
  );
  return system_settings_form($form);
}

/**
 * Implementation of hook_init().
 *
 * We can't move this into environment_indicator_footer(), because PHP-only based themes
 * like chameleon load and output scripts and stylesheets in front of
 * theme_closure(), so we ensure our styles and scripts are loaded on
 * all pages via hook_init().
 */
function environment_indicator_init() {
  if (!user_access('access environment indicator') || environment_indicator_suppress(FALSE)) {
    return;
  }

  global $user, $language;

  $path = drupal_get_path('module', 'environment_indicator');
  drupal_add_css($path .'/environment_indicator.css', 'module', 'all', FALSE);

  // Performance: Defer execution.
  drupal_add_js($path .'/environment_indicator.js', 'module', 'header', TRUE);

  if ($setting = variable_get('environment_indicator_margin', 1)) {
    $settings['margin'] = $setting;
  }
  if ($setting = variable_get('environment_indicator_position', 1)) {
    $settings['position'] = $setting;
  }
  if ($setting = variable_get('environment_indicator_text', 1)) {
    $settings['text'] = $setting;
  }
  if ($setting = variable_get('environment_indicator_color', 1)) {
    $settings['color'] = $setting;
  }

  drupal_add_js(array('environment_indicator' => $settings), 'setting');
}

/**
 * Suppress display of administration menu.
 *
 * This function should be called from within another module's page callback
 * (preferably using module_invoke()) when the indicator should not be displayed.
 * This is useful for modules that implement popup pages or other special
 * pages where the menu would be distracting or break the layout.
 *
 * @param $set
 *   Defaults to TRUE. If called before hook_footer, the menu will not be
 *   displayed. If FALSE is passed, the suppression state is returned.
 */
function environment_indicator_suppress($set = TRUE) {
  if (!variable_get('environment_indicator_enabled', 1)) {
    return TRUE;
  }
  static $suppress = FALSE;
  // drupal_add_js() must only be invoked once.
  if (!empty($set) && $suppress === FALSE) {
    $suppress = TRUE;
    drupal_add_js(array('environment_indicator' => array('suppress' => 1)), 'setting');
  }
  return $suppress;
}
